<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DagBox: DagBox Communication Protocol v1</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DagBox
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">DagBox Communication Protocol v1 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>DagBox Communication Protocol (DCP) defines the protocol used by the clients, workers and the broker to communicate. This document describes the v1 version of the protocol.</p>
<p>It is largely inspired by the <a href="https://rfc.zeromq.org/spec:7/MDP/&gt;">Majordomo Protocol</a>.</p>
<h2>License of the Document</h2>
<p>Copyright 2017 Kaan Genç</p>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license"></a><br />
This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<h2>Language</h2>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="https://tools.ietf.org/html/rfc2119&gt;">RFC 2119, Key words for use in RFCs to Indicate Requirement Levels</a>.</p>
<h2>Goals</h2>
<p>The DagBox Communication Protocol (DCP) is a reliable, service oriented protocol which describes the communication between services, clients and a broker. The goals of the protocol are:</p>
<ul>
<li>Allow requests to be routed to workers based on service names.</li>
<li>Allow brokers to distribute work to multiple workers efficiently.</li>
<li>Allow clients to perform multiple requests without waiting for replies.</li>
<li>Allow peers to detect disconnects.</li>
</ul>
<h2>Architecture</h2>
<div class="image">
<object type="image/svg+xml" data="protocol-architecture.svg">protocol-architecture.svg</object>
<div class="caption">
An overview of DCP: One broker, multiple clients and workers. Some workers have the same service name. Both clients and workers can send requests.</div></div>
<p> There are 3 kinds of components in DCP. These are clients, workers and broker. There MAY be any number of clients and workers, and there MUST be 1 and only 1 broker. Components SHALL communicate using ØMQ. The broker acts as a persistent, central point of communication. Other components can connect to the broker to gain access to the system. When a component connects, it is considered to be a client. A client MAY register itself as a service to become a worker.</p>
<p>Clients are able to send requests. Workers are able to both send requests, and also accept requests and return replies. The broker is tasked with maintaining a queue for each service. Requests SHOULD be queued, and served to workers as they become available to accept work.</p>
<p>The broker and workers are NOT REQUIRED to persistantly hold requests. Requests may be lost if one of these components crashes. Clients SHOULD keep track of when they have sent the request and retry if it exceeds a client-defined timeout.</p>
<h2>Message Format</h2>
<div class="image">
<object type="image/svg+xml" data="protocol-header.svg">protocol-header.svg</object>
<div class="caption">
DCP message header.</div></div>
<p> DCP uses the ØMQ's multiple message part functionality to format messages. All DCP messages start with the DCP header. The header is composed of 4 message parts:</p>
<ul>
<li>Sender address: This part is automatically inserted by ØMQ for clients and workers when the message is first sent, and stripped when a reply is recieved. The broker MUST insert the address of the component that the message is being sent to in this part.</li>
<li>Address delimiter: This is an empty part signifiying the end of the sender address.</li>
<li>Protocol: This part contains 5 bytes, the characters <code>DGBX</code> followed by an unsigned 8-bit number describing the supported version of DCP.</li>
<li>Message Type: This part contains only 1 byte, an unsigned 8-bit number describing the type of the message.</li>
</ul>
<h2>Connection</h2>
<p>The broker MUST always accept connections on a router type (<code>ZMQ_ROUTER</code>) ØMQ socket. It MAY open 1 or more sockets. It MAY use any transport that is supported by ØMQ.</p>
<p>Other components MUST connect to the broker using a dealer type (<code>ZMQ_DEALER</code>) socket. Informing the components of the broker's address is out of this protocol's scope; any solution may be used.</p>
<p>For clients, no message needs to be sent on a connection. Workers MUST send a registration message to register the service they provide. The registration message has the following format:</p>
<div class="image">
<object type="image/svg+xml" data="protocol-registration.svg">protocol-registration.svg</object>
<div class="caption">
Registration message format.</div></div>
<ul>
<li>DCP Header, with message type <code>0x01</code>.</li>
<li>Service name, a string of any number of bytes. MAY contain any character.</li>
</ul>
<p>If the registration is successful, the broker will confirm it by responding with the same message.</p>
<h2>Requests &amp; Replies</h2>
<p>Both clients and workers MAY send requests. Requests MUST have the following format:</p>
<div class="image">
<object type="image/svg+xml" data="protocol-request.svg">protocol-request.svg</object>
<div class="caption">
Request message format.</div></div>
<ul>
<li>DCP Header, with message type <code>0x04</code>.</li>
<li>Service name, a string of any number of bytes. MAY contain any character. The request SHALL be routed to a worker that provides this service.</li>
<li>Client address. This part is optional for clients. The broker MUST insert the address of the client that sent the request here, if and only if this part was missing.</li>
<li>Client address delimiter, an empty frame that shows the end of the client address.</li>
<li>Metadata parts. Any number of non-empty parts MAY be inserted here by the client. The broker MUST NOT modify these parts when routing the message, and workers MUST copy these parts into the reply without any modifications.</li>
<li>Metadata delimiter, an empty part that shows the end of the metadata parts.</li>
<li>Data parts. Any number of parts may be inserted here by the client. The format of the parts depend on the service the message is being sent to.</li>
</ul>
<p>Reply messages have a very similar format. There are only two differences for the reply messages:</p>
<ul>
<li>The message type is <code>0x05</code>.</li>
<li>The service name is not included.</li>
</ul>
<p>Clients MAY send multiple requests without waiting for a reply. The replies will not necessarily arrive in the same order as requests, the client SHOULD use the metadata parts to track which reply corresponds to which request.</p>
<p>If the broker or one of the workers crash, some request and reply messages might be lost. Clients SHOULD keep copies of the requests they have sent and retry them if they don't get a reply in a reasonable amount of time.</p>
<p>The broker SHALL serve requests to the workers providing the matching service. Once a worker has been given a request, the broker SHOULD NOT give more requests to that worker until the it has responded to the broker. Once given a request, a worker can do one of the following:</p>
<ul>
<li>Complete the request and respond with a reply</li>
<li>Complete the work only partially, then respond with a request for another service to complete the rest</li>
<li>Respond with a heartbeat to ask for more work</li>
</ul>
<h2>Heartbeats</h2>
<p>Clients MUST NOT send heartbeat messages to the broker.</p>
<p>Workers MUST periodically send heartbeat messages to the broker at an implementation-defined interval, agreed upon with the broker. If the worker has sent any other message to the broker in this interval, it MAY skip a heartbeat message.</p>
<p>There are two kinds of heartbeat messages, ping and pong. Clients as workers MUST sent ping messages. The broker MUST respond to every ping message with a pong message.</p>
<p>The heartbeat messages are header-only, they MUST NOT contain any parts other than the header. The ping messages have the type <code>0x02</code> and pong messages have the type <code>0x03</code>.</p>
<p>If the broker receives a heartbeat message from a worker that is not registered for any service, the broker MUST respond with a reconnect message. A reconnect message is a header-only message with the type `0x06. A worker that receives a reconnect message MUST send a registration message to the broker.</p>
<h2>Security</h2>
<p>DCP does not implement any authorization, authentication or encryption mechanisms. Any security requirements should be fulfilled by layering other solutions such as kernel namespaces and virtual private networks.</p>
<h2>Comparison to MDP</h2>
<p>Compared to MDP, DCP has several advantages:</p>
<ul>
<li>Clients can send multiple requests without waiting for response, which makes it possible for a single client to utilize the resources of the system more efficiently.</li>
<li>Workers can send heartbeats while they are busy processing a request to ask for more work. This allows workers which can process requests asynchronous to avoid waiting.</li>
<li>Workers can send requests, allowing multiple workers to cooperate on a single request by passing it to other services. This allows complex requests to be split among multiple services. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon May 22 2017 00:20:02 for DagBox by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
